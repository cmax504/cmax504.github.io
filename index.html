<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Humanist's Toolkit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-dark: #2c3e50; --primary-light: #ecf0f1; --accent-color: #3498db;
            --accent-color-hover: #2980b9; --teach-color: #27ae60; --teach-color-hover: #229954;
            --stop-color: #c0392b; --stop-color-hover: #a93226; --save-color: #8e44ad; --save-color-hover: #7d3c98;
            --duplicate-color: #16a085; --duplicate-color-hover: #117a65; --divide-color: #e67e22; --divide-color-hover: #d35400;
            --text-color-dark: #34495e; --text-color-light: #ffffff; --border-color: #bdc3c7;
            --font-heading: 'Playfair Display', serif; --font-body: 'Lato', sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        html { scroll-behavior: smooth; }
        body { font-family: var(--font-body); line-height: 1.6; background-color: var(--primary-light); color: var(--text-color-dark); overflow-x: hidden; }
        .navbar { background-color: var(--primary-dark); position: fixed; top: 0; width: 100%; z-index: 1000; padding: 1rem 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-container { display: flex; justify-content: center; align-items: center; list-style: none; }
        .nav-item { margin: 0 20px; position: relative; }
        .nav-item a { color: var(--text-color-light); text-decoration: none; font-size: 1.1rem; font-weight: 700; padding: 5px 10px; border-radius: 4px; transition: background-color 0.3s ease; cursor: pointer; display: block; }
        .nav-item > a:hover, .nav-item a.active { background-color: var(--accent-color); }
        .dropdown { display: none; position: absolute; top: 100%; left: 0; background-color: var(--primary-dark); list-style: none; padding: 0.5rem 0; border-radius: 0 0 4px 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); min-width: 150px; }
        .nav-item:hover .dropdown { display: block; }
        .dropdown li a:hover { background-color: var(--accent-color); }
        .page-content { display: block; }
        .hero-parallax { background-image: url('https://images.unsplash.com/photo-1524995997946-a1c2e315a42f?ixlib=rb-4.0.3&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format=fit=crop&w=1770&q=80'); min-height: 85vh; background-position: center; background-repeat: no-repeat; background-size: cover; position: relative; display: flex; justify-content: center; align-items: center; text-align: center; color: var(--text-color-light); }
        .hero-parallax::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); }
        .hero-content { position: relative; z-index: 1; max-width: 800px; padding: 2rem; }
        .hero-title { font-family: var(--font-heading); font-size: 4rem; margin-bottom: 1rem; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
        .hero-description { font-size: 1.25rem; font-weight: 300; max-width: 600px; margin: 0 auto; }
        .site-footer { background-color: var(--primary-dark); color: rgba(255, 255, 255, 0.7); text-align: center; padding: 1.5rem; font-size: 0.9rem; }
        .content-area { padding: 4rem 2rem; background-color: #ffffff; position: relative; }
        .content-container { max-width: 900px; margin: 0 auto; }
        #lesson-planner .content-area, #my-lessons .content-area { padding-top: 120px; min-height: 100vh; }
        
        /* Lesson Planner Form Styles */
        .form-view { transition: opacity 0.5s, transform 0.5s; height: calc(100vh - 120px); overflow-y: auto; padding: 1px 15px 1px 1px; }
        .lesson-form .form-group { margin-bottom: 1.5rem; }
        .lesson-form label { display: block; font-weight: 700; margin-bottom: 0.5rem; color: var(--primary-dark); }
        .lesson-form input[type="text"], .lesson-form textarea, .lesson-form input[type="number"] { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; font-family: var(--font-body); transition: border-color 0.3s, box-shadow 0.3s; user-select: text;}
        .lesson-form input:focus, .lesson-form textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 5px rgba(52, 152, 219, 0.5); }
        .lesson-form textarea { min-height: 120px; resize: vertical; }
        #activities-container .activity-item { position: relative; background-color: var(--primary-light); border-left: 4px solid var(--accent-color); padding: 1.5rem; margin-bottom: 1rem; border-radius: 4px; transition: all 0.5s ease-in-out; }
        #activities-container .activity-item.deleting { max-height: 0 !important; opacity: 0; padding: 0; margin: 0; border: none; }
        .activity-item-header { display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem; }
        .activity-item-header .form-group { flex-grow: 1; margin-bottom: 0; }
        .sub-activity-container { padding-left: 1rem; border-left: 2px dashed var(--border-color); }
        .sub-activity-item { display: flex; gap: 1.5rem; padding-top: 1rem; position: relative; } .sub-activity-item:not(:first-child) { border-top: 1px solid var(--border-color); }
        .sub-activity-content { flex-grow: 1; }
        .sub-activity-label { writing-mode: vertical-rl; text-orientation: mixed; color: #aaa; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .minutes-group input { width: 80px; }
        .activity-footer { display: flex; justify-content: flex-end; margin-top: 1rem; }
        .btn { padding: 1rem; color: white; border: none; border-radius: 4px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
        .divide-activity-btn { font-size: 0.9rem; padding: 0.5rem 1rem; background-color: var(--divide-color); } .divide-activity-btn:hover { background-color: var(--divide-color-hover); }
        .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .save-lesson-btn { flex-grow: 1; background-color: var(--save-color); } .save-lesson-btn:hover { background-color: var(--save-color-hover); }
        .add-activity-btn { flex-grow: 1; background-color: var(--accent-color); } .add-activity-btn:hover { background-color: var(--accent-color-hover); }
        .teach-lesson-btn { flex-grow: 1; background-color: var(--teach-color); } .teach-lesson-btn:hover { background-color: var(--teach-color-hover); }
        .total-time-widget { position: sticky; top: 20px; float: right; background-color: var(--primary-dark); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: center; z-index: 10; margin-bottom: 1rem;}
        .delete-activity-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; font-size: 1.5rem; color: var(--stop-color); cursor: pointer; transition: transform 0.2s ease, color 0.2s ease; line-height: 1; }
        .delete-activity-btn:hover { transform: scale(1.2); color: var(--stop-color-hover); }
        .delete-sub-activity-btn { position: absolute; top: 1rem; right: 0; background: none; border: none; font-size: 1.2rem; color: var(--stop-color); cursor: pointer; transition: transform 0.2s ease, color 0.2s ease; }
        .delete-sub-activity-btn:hover { transform: scale(1.2); color: var(--stop-color-hover); }
        
        /* Teach Mode, My Lessons, Modals */
        .teach-view { display: none; height: calc(100vh - 120px); transition: opacity 0.5s, transform 0.5s; position: absolute; top: 120px; left: 0; right: 0; }
        .teach-view-container { display: flex; width: 100%; height: 100%; padding-left: 100px; position: relative; background: #fff; }
        .resizer { width: 10px; background: var(--border-color); cursor: col-resize; z-index: 10; }
        .teach-panel { height: 100%; padding: 2rem; overflow-y: auto; }
        .teach-view-left { flex-basis: 50%; } .teach-view-right { flex-basis: 50%; background: var(--primary-light); border-left: 1px solid var(--border-color); }
        .static-info-item { margin-bottom: 2rem; } .static-info-item h3 { font-family: var(--font-heading); color: var(--primary-dark); border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; margin-bottom: 0.5rem; } .static-info-item p { white-space: pre-wrap; user-select: text; }
        .activities-display-container { height: 100%; overflow: hidden; position: relative; } .activities-display-scroller { position: absolute; width: 100%; top: 0; transition: transform 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .activity-display-item { padding: 1.5rem; margin: 0 1rem 1rem 0; border: 1px solid var(--border-color); border-radius: 8px; transition: box-shadow 0.5s; }
        .sub-activity-display-item { opacity: 0.4; transform: scale(0.98); transition: opacity 0.5s, transform 0.5s, border-color 0.5s; padding: 1rem 0; }
        .sub-activity-display-item:not(:first-child) { border-top: 1px dashed var(--border-color); }
        .sub-activity-display-item.is-active { opacity: 1; transform: scale(1); }
        .activity-display-item.is-active-parent { box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4); border-color: var(--accent-color); }
        .activity-display-item-header { display: flex; justify-content: space-between; align-items: baseline; }
        .activity-display-item h4 { font-family: var(--font-heading); font-size: 1.5rem; margin-bottom: 1rem; }
        .activity-display-item-header .time-display { font-size: 1.1rem; color: #777; white-space: nowrap; font-style: normal; }
        .sub-activity-display-item-header { display: flex; justify-content: space-between; font-weight: bold; }
        .sub-activity-display-item p { margin-top: 0.5rem; white-space: pre-wrap; user-select: text; }
        .activity-progress-bar { height: 6px; background-color: #ddd; border-radius: 3px; margin-bottom: 1rem; overflow: hidden; display: none; }
        .activity-progress-bar-fill { width: 0%; height: 100%; background-color: var(--duplicate-color); border-radius: 3px; transition: width 0.2s linear; }
        #lesson-planner.progress-bars-active .activity-progress-bar { display: block; }
        .stop-teaching-btn { position: fixed; bottom: 2rem; right: 2rem; background-color: var(--stop-color); color: white; border: none; padding: 1rem 1.5rem; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; transform: scale(0); opacity: 0; z-index: 1100; }
        .stop-teaching-btn:hover { background-color: var(--stop-color-hover); }
        .time-controls-container { position: absolute; top: 0; left: 0; width: 100px; height: 100%; display: flex; flex-direction: column; align-items: center; padding: 1rem 0; background: var(--primary-light); border-right: 1px solid var(--border-color); z-index: 20; }
        #teach-time-display { font-weight: 700; font-size: 1.1rem; text-align: center; height: 40px; }
        .timer-controls button { background: none; border: none; font-size: 2.5rem; cursor: pointer; color: var(--primary-dark); transition: color 0.3s; height: 50px; } .timer-controls button:hover { color: var(--accent-color); }
        .teach-options { margin-top: auto; font-size: 0.9rem; width: 100%; padding: 0 5px; } 
        .teach-options label { margin: 0.5rem; cursor: pointer; display: flex; align-items: center; justify-content: flex-start; }
        .teach-options input { margin-right: 8px; }
        .time-bar-container { position: relative; width: 15px; flex-grow: 1; background: #ddd; border-radius: 10px; margin: 1rem 0; cursor: pointer; }
        .time-bar-fill { position: absolute; width: 100%; background: var(--teach-color); border-radius: 10px; bottom: 0; }
        .time-bar-handle { position: absolute; left: 50%; transform: translate(-50%, 50%); width: 25px; height: 10px; background: var(--primary-dark); border-radius: 3px; cursor: ns-resize; }
        #lesson-planner.teach-mode-active .form-view { opacity: 0; transform: translateY(-20px); pointer-events: none; height: 0; overflow: hidden; }
        #lesson-planner.teach-mode-active .teach-view { display: block; opacity: 1; transform: translateY(0); }
        #lesson-planner.teach-mode-active .stop-teaching-btn { transform: scale(1); opacity: 1; }
        .my-lessons-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .lesson-list-item { display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; background: var(--primary-light); }
        .lesson-list-item h3 { font-family: var(--font-heading); color: var(--primary-dark); }
        .lesson-list-item .actions { display: flex; flex-wrap: wrap; gap: 1rem; }
        .lesson-list-item .btn-open { background-color: var(--teach-color); } .lesson-list-item .btn-open:hover { background-color: var(--teach-color-hover); }
        .lesson-list-item .btn-duplicate { background-color: var(--duplicate-color); } .lesson-list-item .btn-duplicate:hover { background-color: var(--duplicate-color-hover); }
        .lesson-list-item .btn-delete, .btn-delete-all { background-color: var(--stop-color); } .lesson-list-item .btn-delete:hover, .btn-delete-all:hover { background-color: var(--stop-color-hover); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 500px; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; font-family: var(--font-heading); } .modal-content input { user-select: text; width: 100%; padding: 0.75rem; margin-top: 1rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1rem; }
        .modal-actions { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem; } .modal-actions .btn { padding: 0.75rem 1.5rem; }
        .btn-cancel { background-color: #7f8c8d; }
        .popup-message { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--primary-dark); color: white; padding: 1rem 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.4s ease, opacity 0.4s ease; opacity: 0; pointer-events: none; z-index: 2100; }
        .popup-message.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body>
    <nav class="navbar">
        <ul class="nav-container">
            <li class="nav-item"><a class="nav-link active" data-page="home">Home</a></li>
            <li class="nav-item">
                <a class="nav-link" data-page="lesson-planner">Lesson Planner</a>
                <ul class="dropdown">
                    <li><a class="nav-link" data-page="my-lessons">My Lessons</a></li>
                </ul>
            </li>
        </ul>
    </nav>

    <main id="home" class="page-content"><header class="hero-parallax" id="hero"><div class="hero-content"><h1 class="hero-title">The Humanist's Toolkit</h1><p class="hero-description">Though the word "Humanist" is in the title, this free resource is designed to assist researchers and educators of all sorts. Explore and enjoy! Much more to come!</p></div></header><section class="content-area" style="min-height: 40vh; background-color: #ffffff;"></section><footer class="site-footer"><p>Created by Mr. Cairo A. Maxwell of the University of Virginia, with the coding assistance of Google's Gemini API.</p></footer></main>

    <main id="lesson-planner" class="page-content" style="display: none;">
        <div class="content-area">
            <div class="form-view"><form class="lesson-form"><div class="total-time-widget"><h3 >Total Lesson Time</h3><p id="total-time-display">0 Minutes</p></div><input type="hidden" id="current-lesson-name" value=""><h1>Lesson Planner</h1><div class="form-group"><label for="course-name">Course Name</label><input type="text" id="course-name"></div><div class="form-group"><label for="unit-name">Unit Name</label><input type="text" id="unit-name"></div><div class="form-group"><label for="course-objectives">Relevant Course Objectives</label><textarea id="course-objectives"></textarea></div><div class="form-group"><label for="learning-goals">Learning Goals of the Lesson</label><textarea id="learning-goals"></textarea></div><h2>Activities</h2><div id="activities-container"></div><div class="form-actions"><button type="button" class="btn save-lesson-btn" id="save-lesson-btn">Save Lesson</button><button type="button" class="btn add-activity-btn" id="add-activity-btn">+ Add Activity</button><button type="button" class="btn teach-lesson-btn" id="teach-lesson-btn">&#9658; Teach My Lesson</button></div></form></div>
            <div class="teach-view"><div class="time-controls-container"><p id="teach-time-display">00:00 / 00:00</p><div class="timer-controls"><button id="play-pause-btn">&#9658;</button></div><div class="time-bar-container" id="time-bar-container"><div class="time-bar-fill" id="time-bar-fill"></div><div class="time-bar-handle" id="time-bar-handle"></div></div><div class="teach-options"><label><input type="radio" name="timer-mode" value="stopwatch" checked> Stopwatch</label><label><input type="radio" name="timer-mode" value="timer"> Timer</label><label><input type="checkbox" id="progress-bar-toggle"> Progress Bars</label><label><input type="checkbox" id="kinetic-numbers-toggle"> Kinetic Numbers</label></div></div><div class="teach-view-container"><div class="teach-panel teach-view-left"><div class="activities-display-container"><div class="activities-display-scroller" id="activities-display-scroller"></div></div></div><div class="resizer" id="resizer"></div><div class="teach-panel teach-view-right" id="static-info-panel"></div></div></div>
            <button class="stop-teaching-btn" id="stop-teaching-btn">&#9724; Stop Teaching</button>
        </div>
    </main>

    <main id="my-lessons" class="page-content" style="display: none;"><div class="content-area"><div class="content-container"><div class="my-lessons-header"><h1>My Lessons</h1><button class="btn btn-delete-all" id="delete-all-btn">Delete All Lessons</button></div><div id="lesson-list-container"></div></div></div></main>
    <div class="modal-overlay" id="save-modal-overlay"><div class="modal-content"><h2>Save Lesson</h2><p>Please enter a name for this lesson plan. If a lesson with this name already exists, it will be overwritten.</p><input type="text" id="lesson-name-input" placeholder="e.g., Intro to Renaissance Art"><div class="modal-actions"><button type="button" class="btn btn-cancel" id="cancel-save-btn">Cancel</button><button type="button" class="btn save-lesson-btn" id="confirm-save-btn">Save</button></div></div></div>
    <div class="popup-message" id="popup-message">Save Successful!</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- ROBUST NAVIGATION LOGIC ---
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            const navigateToPage = (pageId, isNewLesson = false) => {
                if (!pageId) return;
                const targetLink = document.querySelector(`.nav-link[data-page="${pageId}"]`);
                if (!targetLink) return;
                navLinks.forEach(l => l.classList.remove('active'));
                targetLink.classList.add('active');
                const parentNavItem = targetLink.closest('.nav-item');
                if (parentNavItem.querySelector('.dropdown')) { parentNavItem.querySelector('a[data-page="lesson-planner"]').classList.add('active'); }
                pages.forEach(page => page.style.display = 'none');
                document.getElementById(pageId).style.display = 'block';
                if (pageId === 'my-lessons') { loadLessonsIntoView(); } 
                else if (pageId === 'lesson-planner' && isNewLesson) { 
                    document.getElementById('current-lesson-name').value = ''; document.querySelector('.lesson-form').reset();
                    activitiesContainer.innerHTML = ''; updateTotalTime();
                }
            };
            navLinks.forEach(link => { link.addEventListener('click', function(e) {
                const isNew = this.dataset.page === 'lesson-planner' && !this.closest('.dropdown');
                navigateToPage(this.dataset.page, isNew);
            }); });

            // --- Parallax Effect Script ---
            const hero = document.getElementById('hero');
            if (hero) window.addEventListener('scroll', () => { hero.style.backgroundPositionY = window.pageYOffset * 0.5 + 'px'; });

            // --- Lesson Planner Functionality ---
            const lessonPlannerPage = document.getElementById('lesson-planner'); const addActivityBtn = document.getElementById('add-activity-btn'); const activitiesContainer = document.getElementById('activities-container'); const totalTimeDisplay = document.getElementById('total-time-display');
            const updateTotalTime = () => { let totalMinutes = 0; activitiesContainer.querySelectorAll('.activity-minutes').forEach(input => { totalMinutes += parseInt(input.value, 10) || 0; }); totalTimeDisplay.textContent = `${totalMinutes} Minutes`; return totalMinutes; };
            const updateActivityPartVisibility = (activityItem) => {
                const subItems = activityItem.querySelectorAll('.sub-activity-item');
                subItems.forEach((subItem, index) => {
                    subItem.querySelector('.sub-activity-label').style.display = subItems.length > 1 ? '' : 'none';
                    subItem.querySelector('.delete-sub-activity-btn').style.display = subItems.length > 1 ? '' : 'none';
                    subItem.querySelector('.sub-activity-label').textContent = `Part ${index + 1}`;
                });
            };
            const createSubActivityElement = (minutes = '', notes = '') => { return `<div class="sub-activity-item"><div class="sub-activity-label"></div><div class="sub-activity-content"><div class="sub-activity-header"><div class="form-group minutes-group"><label>Minutes</label><input type="number" class="activity-minutes" value="${minutes}" min="0"></div></div><div class="form-group"><label>Notes</label><textarea>${notes}</textarea></div></div><button type="button" class="delete-sub-activity-btn">&times;</button></div>`; };
            const createActivityElement = (name = '', subActivities = [{ minutes: '', notes: '' }]) => {
                const activityEl = document.createElement('div'); activityEl.className = 'activity-item';
                const subActivitiesHtml = subActivities.map(sub => createSubActivityElement(sub.minutes, sub.notes)).join('');
                activityEl.innerHTML = `<button type="button" class="delete-activity-btn">&times;</button><div class="activity-item-header"><div class="form-group"><label>Activity Name</label><input type="text" class="activity-name" value="${name}"></div></div><div class="sub-activity-container">${subActivitiesHtml}</div><div class="activity-footer"><button type="button" class="btn divide-activity-btn">Divide</button></div>`;
                updateActivityPartVisibility(activityEl); return activityEl;
            };
            addActivityBtn.addEventListener('click', () => { const newActivity = createActivityElement(); newActivity.style.cssText = 'max-height:0; opacity:0; padding-top:0; padding-bottom:0; margin-bottom:0;'; activitiesContainer.appendChild(newActivity); setTimeout(() => { newActivity.style.cssText = ''; }, 10); });
            activitiesContainer.addEventListener('input', e => { if (e.target.classList.contains('activity-minutes')) updateTotalTime(); });
            activitiesContainer.addEventListener('click', e => {
                if (e.target.classList.contains('delete-activity-btn')) { const activityItem = e.target.closest('.activity-item'); activityItem.classList.add('deleting'); setTimeout(() => { activityItem.remove(); updateTotalTime(); }, 500); }
                else if (e.target.classList.contains('delete-sub-activity-btn')) {
                    const subActivityItem = e.target.closest('.sub-activity-item'); const parentActivity = subActivityItem.closest('.activity-item');
                    if (parentActivity.querySelectorAll('.sub-activity-item').length > 1) { subActivityItem.remove(); updateActivityPartVisibility(parentActivity); updateTotalTime(); } 
                    else { alert("You cannot delete the last part of an activity. Delete the whole activity instead."); }
                }
                else if (e.target.classList.contains('divide-activity-btn')) {
                    const parentActivity = e.target.closest('.activity-item'); const subContainer = parentActivity.querySelector('.sub-activity-container');
                    subContainer.insertAdjacentHTML('beforeend', createSubActivityElement()); updateActivityPartVisibility(parentActivity);
                }
            });

            // --- Save/Load Functionality ---
            const saveModalOverlay = document.getElementById('save-modal-overlay'); const saveLessonBtn = document.getElementById('save-lesson-btn'); const confirmSaveBtn = document.getElementById('confirm-save-btn'); const cancelSaveBtn = document.getElementById('cancel-save-btn'); const lessonNameInput = document.getElementById('lesson-name-input'); const currentLessonNameInput = document.getElementById('current-lesson-name'); const popupMessage = document.getElementById('popup-message'); const lessonListContainer = document.getElementById('lesson-list-container'); const deleteAllBtn = document.getElementById('delete-all-btn');
            saveLessonBtn.addEventListener('click', () => { lessonNameInput.value = currentLessonNameInput.value; saveModalOverlay.classList.add('active'); });
            cancelSaveBtn.addEventListener('click', () => saveModalOverlay.classList.remove('active'));
            confirmSaveBtn.addEventListener('click', () => {
                const lessonName = lessonNameInput.value.trim(); if (!lessonName) { alert("Please enter a name for the lesson."); return; }
                const lessonData = { courseName: document.getElementById('course-name').value, unitName: document.getElementById('unit-name').value, courseObjectives: document.getElementById('course-objectives').value, learningGoals: document.getElementById('learning-goals').value, activities: [] };
                activitiesContainer.querySelectorAll('.activity-item').forEach(item => { const subActivities = []; item.querySelectorAll('.sub-activity-item').forEach(subItem => { subActivities.push({ minutes: subItem.querySelector('.activity-minutes').value, notes: subItem.querySelector('textarea').value }); }); lessonData.activities.push({ name: item.querySelector('.activity-name').value, subActivities }); });
                localStorage.setItem(`lesson_${lessonName}`, JSON.stringify(lessonData)); currentLessonNameInput.value = lessonName; saveModalOverlay.classList.remove('active');
                popupMessage.classList.add('show'); setTimeout(() => popupMessage.classList.remove('show'), 2000);
            });
            const loadLessonsIntoView = () => {
                lessonListContainer.innerHTML = ''; const keys = Object.keys(localStorage).filter(k => k.startsWith('lesson_'));
                if (keys.length === 0) { lessonListContainer.innerHTML = '<p>No saved lessons found.</p>'; deleteAllBtn.style.display = 'none'; return; }
                deleteAllBtn.style.display = 'block';
                keys.forEach(key => { const lessonName = key.replace('lesson_', ''); const item = document.createElement('div'); item.className = 'lesson-list-item'; item.innerHTML = `<h3>${lessonName}</h3><div class="actions"><button class="btn btn-open" data-lesson-name="${lessonName}">Open</button><button class="btn btn-duplicate" data-lesson-name="${lessonName}">Duplicate</button><button class="btn btn-delete" data-lesson-name="${lessonName}">Delete</button></div>`; lessonListContainer.appendChild(item); });
            };
            lessonListContainer.addEventListener('click', e => {
                const lessonName = e.target.dataset.lessonName; if (!lessonName) return;
                if (e.target.classList.contains('btn-open')) {
                    const data = JSON.parse(localStorage.getItem(`lesson_${lessonName}`)); if (!data) return;
                    document.getElementById('course-name').value = data.courseName; document.getElementById('unit-name').value = data.unitName; document.getElementById('course-objectives').value = data.courseObjectives; document.getElementById('learning-goals').value = data.learningGoals; currentLessonNameInput.value = lessonName;
                    activitiesContainer.innerHTML = ''; data.activities.forEach(act => { const el = createActivityElement(act.name, act.subActivities); activitiesContainer.appendChild(el); });
                    updateTotalTime(); navigateToPage('lesson-planner', false);
                } else if (e.target.classList.contains('btn-delete')) {
                    if (confirm(`Are you sure you want to delete the lesson "${lessonName}"? This cannot be undone.`)) { localStorage.removeItem(`lesson_${lessonName}`); loadLessonsIntoView(); }
                } else if (e.target.classList.contains('btn-duplicate')) {
                    const originalData = localStorage.getItem(`lesson_${lessonName}`); if (!originalData) return;
                    let newName = `Copy of ${lessonName}`; let counter = 2;
                    while (localStorage.getItem(`lesson_${newName}`)) { newName = `Copy of ${lessonName} (${counter++})`; }
                    localStorage.setItem(`lesson_${newName}`, originalData); loadLessonsIntoView();
                }
            });
            deleteAllBtn.addEventListener('click', () => { if (confirm('Are you sure you want to delete ALL saved lessons? This action is permanent and cannot be undone.')) { Object.keys(localStorage).filter(k => k.startsWith('lesson_')).forEach(k => localStorage.removeItem(k)); loadLessonsIntoView(); } });

            // --- Teach Mode Functionality ---
            const teachLessonBtn = document.getElementById('teach-lesson-btn'); const stopTeachingBtn = document.getElementById('stop-teaching-btn'); const staticInfoPanel = document.getElementById('static-info-panel'); const activitiesDisplayScroller = document.getElementById('activities-display-scroller'); const playPauseBtn = document.getElementById('play-pause-btn'); const teachTimeDisplay = document.getElementById('teach-time-display'); const timeBarFill = document.getElementById('time-bar-fill'); const timeBarHandle = document.getElementById('time-bar-handle'); const timeBarContainer = document.getElementById('time-bar-container');
            const progressBarToggle = document.getElementById('progress-bar-toggle'); const kineticNumbersToggle = document.getElementById('kinetic-numbers-toggle');
            let teachModeActivities = []; let parentActivitiesData = []; let totalLessonSeconds = 0; let currentSeconds = 0; let timerInterval = null; let isPaused = true;
            const formatTime = (seconds) => { const mins = String(Math.floor(Math.abs(seconds)/60)).padStart(2,'0'); const secs = String(Math.abs(seconds)%60).padStart(2,'0'); return `${mins}:${secs}`; };
            const updateUI = () => {
                const timerMode = document.querySelector('input[name="timer-mode"]:checked').value; const progress = totalLessonSeconds > 0 ? (currentSeconds/totalLessonSeconds) : 0; const totalTimeFormatted = formatTime(totalLessonSeconds);
                if (timerMode === 'timer') { const remainingSeconds = totalLessonSeconds - currentSeconds; teachTimeDisplay.textContent = formatTime(remainingSeconds); const fillHeight = (1 - progress) * 100; timeBarFill.style.height = `${fillHeight}%`; timeBarHandle.style.bottom = `calc(${fillHeight}% - 5px)`; }
                else { teachTimeDisplay.innerHTML = `${formatTime(currentSeconds)} / ${totalTimeFormatted}`; const fillHeight = progress * 100; timeBarFill.style.height = `${fillHeight}%`; timeBarHandle.style.bottom = `calc(${fillHeight}% - 5px)`; }
                let activeSubActivity = null;
                for (const subAct of teachModeActivities) { if (currentSeconds >= subAct.startTime && currentSeconds < subAct.endTime) { activeSubActivity = subAct; break; } }
                document.querySelectorAll('.sub-activity-display-item.is-active, .activity-display-item.is-active-parent').forEach(el => el.classList.remove('is-active', 'is-active-parent'));
                if (activeSubActivity) { const subActEl = document.getElementById(activeSubActivity.id); if (subActEl) { subActEl.classList.add('is-active'); const parentEl = subActEl.closest('.activity-display-item'); parentEl.classList.add('is-active-parent'); activitiesDisplayScroller.style.transform = `translateY(-${parentEl.offsetTop}px)`; } } 
                else { const firstParent = document.getElementById('parent-activity-0'); if(firstParent) activitiesDisplayScroller.style.transform = `translateY(0px)`; }
                parentActivitiesData.forEach(parent => {
                    const parentProgress = (currentSeconds - parent.startTime) / (parent.endTime - parent.startTime); const clampedParentProgress = Math.max(0, Math.min(1, parentProgress));
                    const parentBarFill = document.getElementById(`${parent.parentId}-progress-fill`); if(parentBarFill) parentBarFill.style.width = timerMode === 'timer' ? `${(1 - clampedParentProgress) * 100}%` : `${clampedParentProgress * 100}%`;
                    const timeDisplayEl = document.getElementById(`${parent.parentId}-time`);
                    if (timeDisplayEl) {
                        if (kineticNumbersToggle.checked && activeSubActivity && activeSubActivity.parentId === parent.parentId) {
                            const localSeconds = currentSeconds - parent.startTime; const totalSubSeconds = parent.endTime - parent.startTime;
                            if (timerMode === 'timer') { timeDisplayEl.textContent = formatTime(totalSubSeconds - localSeconds); } else { timeDisplayEl.textContent = `${formatTime(localSeconds)} / ${formatTime(totalSubSeconds)}`; }
                        } else { timeDisplayEl.textContent = `${parent.totalMinutes} min`; }
                    }
                });
                teachModeActivities.forEach(subAct => {
                    const subProgress = (currentSeconds - subAct.startTime) / (subAct.endTime - subAct.startTime); const clampedSubProgress = Math.max(0, Math.min(1, subProgress));
                    const subBarFill = document.getElementById(`${subAct.id}-progress-fill`); if(subBarFill) subBarFill.style.width = timerMode === 'timer' ? `${(1 - clampedSubProgress) * 100}%` : `${clampedSubProgress * 100}%`;
                    const timeDisplayEl = document.getElementById(`${subAct.id}-time`);
                    if (timeDisplayEl) {
                        if (kineticNumbersToggle.checked && subAct.parentTotalSubActivities > 1 && subAct === activeSubActivity) {
                            const localSeconds = currentSeconds - subAct.startTime; const totalSubSeconds = subAct.endTime - subAct.startTime;
                            if (timerMode === 'timer') { timeDisplayEl.textContent = formatTime(totalSubSeconds - localSeconds); } else { timeDisplayEl.textContent = `${formatTime(localSeconds)} / ${formatTime(totalSubSeconds)}`; }
                        } else { timeDisplayEl.textContent = subAct.parentTotalSubActivities > 1 ? `${subAct.minutes} min` : ''; }
                    }
                });
            };
            const startTimer = () => { if (!isPaused || currentSeconds >= totalLessonSeconds) return; isPaused = false; playPauseBtn.innerHTML = '&#9208;'; timerInterval = setInterval(() => { if (currentSeconds < totalLessonSeconds) { currentSeconds++; updateUI(); } else { stopTimer(); updateUI(); } }, 1000); };
            const stopTimer = () => { isPaused = true; clearInterval(timerInterval); timerInterval = null; playPauseBtn.innerHTML = '&#9658;'; };
            const resetTeachMode = () => { stopTimer(); currentSeconds = 0; updateUI(); };
            playPauseBtn.addEventListener('click', () => isPaused ? startTimer() : stopTimer());
            document.querySelectorAll('input[name="timer-mode"], #progress-bar-toggle, #kinetic-numbers-toggle').forEach(el => { el.addEventListener('change', resetTeachMode); });
            progressBarToggle.addEventListener('change', () => lessonPlannerPage.classList.toggle('progress-bars-active'));
            teachLessonBtn.addEventListener('click', () => {
                if (updateTotalTime() === 0) { alert("Please add at least one activity with a time greater than 0."); return; }
                document.querySelector('input[name="timer-mode"][value="stopwatch"]').checked = true;
                teachModeActivities = []; parentActivitiesData = []; let cumulativeTime = 0; let parentIndex = 0;
                Array.from(activitiesContainer.children).forEach(item => {
                    const activityName = item.querySelector('.activity-name').value || `Unnamed Activity`;
                    const subItems = item.querySelectorAll('.sub-activity-item'); const parentStartTime = cumulativeTime; let parentTotalMinutes = 0;
                    subItems.forEach((subItem, subIndex) => {
                        const minutes = parseInt(subItem.querySelector('.activity-minutes').value, 10) || 0;
                        if (minutes > 0) {
                            teachModeActivities.push({ parentId: `parent-activity-${parentIndex}`, id: `sub-activity-${parentIndex}-${subIndex}`, partNumber: subIndex + 1, minutes, notes: subItem.querySelector('textarea').value, startTime: cumulativeTime, endTime: cumulativeTime + (minutes * 60), parentTotalSubActivities: subItems.length });
                            cumulativeTime += minutes * 60; parentTotalMinutes += minutes;
                        }
                    });
                    if (subItems.length > 0) { parentActivitiesData.push({ parentId: `parent-activity-${parentIndex}`, parentName: activityName, totalMinutes: parentTotalMinutes, startTime: parentStartTime, endTime: cumulativeTime, totalSubActivities: subItems.length }); parentIndex++; }
                });
                totalLessonSeconds = cumulativeTime;
                staticInfoPanel.innerHTML = `<div class="static-info-item"><h3>Course Name</h3><p>${document.getElementById('course-name').value||'N/A'}</p></div><div class="static-info-item"><h3>Unit Name</h3><p>${document.getElementById('unit-name').value||'N/A'}</p></div><div class="static-info-item"><h3>Course Objectives</h3><p>${document.getElementById('course-objectives').value||'N/A'}</p></div><div class="static-info-item"><h3>Learning Goals</h3><p>${document.getElementById('learning-goals').value||'N/A'}</p></div>`;
                let html = '';
                parentActivitiesData.forEach(parent => {
                    html += `<div class="activity-display-item" id="${parent.parentId}"><div class="activity-progress-bar"><div class="activity-progress-bar-fill" id="${parent.parentId}-progress-fill"></div></div><div class="activity-display-item-header"><h4>${parent.parentName}</h4><span class="time-display" id="${parent.parentId}-time">${parent.totalMinutes} min</span></div>`;
                    teachModeActivities.filter(act => act.parentId === parent.parentId).forEach(act => {
                        const partLabel = parent.totalSubActivities > 1 ? `Part ${act.partNumber}` : '';
                        const timeLabelHtml = parent.totalSubActivities > 1 ? `<span class="time-display" id="${act.id}-time">${act.minutes} min</span>` : '';
                        html += `<div class="sub-activity-display-item" id="${act.id}">`;
                        if (parent.totalSubActivities > 1) { html += `<div class="activity-progress-bar"><div class="activity-progress-bar-fill" id="${act.id}-progress-fill"></div></div>`; }
                        html += `<div class="sub-activity-display-item-header"><span>${partLabel}</span>${timeLabelHtml}</div><p>${act.notes||' '}</p></div>`;
                    });
                    html += `</div>`;
                });
                activitiesDisplayScroller.innerHTML = html;
                resetTeachMode(); lessonPlannerPage.classList.add('teach-mode-active');
            });
            stopTeachingBtn.addEventListener('click', () => { lessonPlannerPage.classList.remove('teach-mode-active'); stopTimer(); });
            const handleDrag = (el, onDragMove) => { let isDragging = false; const onMouseDown = e => { isDragging = true; onDragMove(e); }; const onMouseMove = e => { if (isDragging) { e.preventDefault(); onDragMove(e); } }; const onMouseUp = () => { isDragging = false; }; el.addEventListener('mousedown', onMouseDown); document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp); };
            const leftPanel = document.querySelector('.teach-view-left');
            handleDrag(document.getElementById('resizer'), e => { const container = leftPanel.parentElement; const newLeftWidth = e.clientX - container.getBoundingClientRect().left; if (newLeftWidth > 200 && newLeftWidth < container.offsetWidth - 300) { leftPanel.style.flexBasis = `${newLeftWidth - 100}px`; } });
            const onTimeBarDrag = e => {
                const timerMode = document.querySelector('input[name="timer-mode"]:checked').value; const rect = timeBarContainer.getBoundingClientRect(); let newProgress;
                if (timerMode === 'timer') { newProgress = (e.clientY - rect.top) / rect.height; } else { newProgress = 1 - ((e.clientY - rect.top) / rect.height); }
                newProgress = Math.max(0, Math.min(1, newProgress)); currentSeconds = Math.round(newProgress * totalLessonSeconds); updateUI();
            };
            handleDrag(timeBarContainer, onTimeBarDrag);
        });
    </script>
</body>
</html>
